---
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.3
  kernelspec:
    display_name: R 3.6.1
    language: R
    name: ir361
---

# Create Dataset


## Setup

```{r}
library(tidyverse)
library(feather)
year <- lubridate::year
```

```{r}
raw_data_file <- "../../../data/incidents_2019-08-11.feather"
largest_observations_file = '../../../preprocessed_data/largest_companies_2019-09-08.feather'
```

## Read Data

```{r}
largest_observations <- read_feather(largest_observations_file)
head(largest_observations)
```

```{r}
raw_data <- read_feather(raw_data_file)
head(raw_data[, 1:20])
```

## Define functions

```{r}
get_latest_name <- function(dataset, id_col, name_col, time_col){
    quo_id_col <- enquo(id_col)
    quo_name_col <- enquo(name_col)
    quo_time_col <- enquo(time_col)
    
    dataset <- dataset %>%
        group_by(!! quo_id_col) %>%
        arrange(desc(!! quo_time_col)) %>%
        mutate(!! quo_name_col := first(!! quo_name_col))
    
    return(dataset)
}
```

```{r}
create_dataset <- function(raw_data, variables, variable_names, operators, 
                           undesired_company_endings, name_col = "Name", time_col = "Time", 
                           recode_bool = c("Significant", "Serious")){
    dataset <- select(raw_data, variables)
    dataset <- rename(dataset, !!! variable_names)
    
    # For option to filter by sample
    dataset$in_sample <- dataset$ID %in% operators
    
    # Clean (unify) company names
    dataset <- get_latest_name(dataset, ID, Name, Time)
    
    # Various cleaning
    dataset$Year = year(dataset[[time_col]])
    dataset[[name_col]] = str_remove_all(dataset[[name_col]], undesired_company_endings)
    dataset[[name_col]] = str_to_title(dataset[[name_col]])
    
    # Recode from yes/no to boolean
    for (column in recode_bool){
        dataset[[column]] <- dataset[[column]] == "YES"
    }
    
    return(dataset)
}
```

## Run

```{r}
variables <- c("OPERATOR_ID", "NAME", "LOCAL_DATETIME", "LOCATION_LATITUDE", 
               "LOCATION_LONGITUDE", "SIGNIFICANT", "SERIOUS", "ON_OFF_SHORE")

variable_names <- c("ID" = "OPERATOR_ID", 
                    "Name" = "NAME", 
                    "Time" = "LOCAL_DATETIME", 
                    "Lat" = "LOCATION_LATITUDE", 
                    "Long" = "LOCATION_LONGITUDE", 
                    "Significant" = "SIGNIFICANT", 
                    "Serious" = "SERIOUS", 
                    "Offshore" = "ON_OFF_SHORE")

undesired_company_endings <- c(" L. P.| L.L.C.|, LLC|, L.P.| L.P.|, LP|LP|LLC|, LIMITED PARTNERSHIP|, A DIVISION OF EXXON MOBIL CORPORATION")
```

```{r}
dataset <- create_dataset(raw_data, variables, variable_names, largest_observations$OPERATOR_ID, undesired_company_endings)
head(dataset)
```

```{r}
write_feather(dataset, paste0("../incident_dashboard/data/dataset_", Sys.Date(), ".feather"))
```
